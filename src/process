#!/bin/bash

# src/process docs/FORPD work

# Handle Ctrl+C gracefully
trap 'echo -e "\nInterrupted by user. Exiting..."; exit 1' INT
if [[ $# -ne 2 ]]; then
    echo "Usage: $0 <directory> <work_directory>"
    exit 1
fi

CMD="./node_modules/@ccorcos/ask-pdf/pdf2md"
DIR="$1"
WORK_DIR="$2"

if [[ ! -d "$DIR" ]]; then
    echo "Error: $DIR is not a directory"
    exit 1
fi

mkdir -p "$WORK_DIR"

# Count total number of PDF files
TOTAL_FILES=$(find "$DIR" -type f -name "*.pdf" | wc -l)
echo "Found $TOTAL_FILES PDF files to process"
CURRENT=0

# Process each PDF file
while IFS= read -r pdf_file; do
    ((CURRENT++))
    md_file="${pdf_file%.pdf}.md"
    if [[ ! -f "$md_file" ]]; then
        echo "($CURRENT/$TOTAL_FILES) Processing: $pdf_file"

        # Get the subdirectory path relative to DIR, to be used as work subdir
        # e.g. if DIR is docs/X and pdf_file is docs/X/Y/Z.pdf
        # then work_subdir will be Y/ so files go to work/Y/
        rel_path=$(dirname "${pdf_file#$DIR/}")
        work_subdir="$WORK_DIR/$rel_path"
        mkdir -p "$work_subdir"

        echo "Running: $CMD \"$pdf_file\" \"$md_file\" \"$work_subdir\""
        $CMD "$pdf_file" "$md_file" "$work_subdir"
    else
        echo "($CURRENT/$TOTAL_FILES) Skipping existing file: $md_file"
    fi
done < <(find "$DIR" -type f -name "*.pdf")

# find "$DIR" -type f -name "*.md" -delete
