#!/bin/bash

# src/summarize docs/FORPD/2024-10-16/

# TODO: use a work directory for caching work?

set -e

if [ -z "$1" ]; then
  echo "Usage: $0 <directory>"
  exit 1
fi

DIR="$1"
RANDOM_ID="$(head -c 6 /dev/urandom | xxd -p)"
SUMMARY="/tmp/summarize-$RANDOM_ID.md"
REFINED="/tmp/refine-$RANDOM_ID.md"
touch "$SUMMARY" "$REFINED"
echo "Created temp files:" >&2
echo "  $SUMMARY" >&2
echo "  $REFINED" >&2

# Summarize
echo "Starting summarization in $(pwd)..." >&2
npx tsx src/gpt.ts prompts/summarize.md "$DIR" > "$SUMMARY"

# Refine
echo "Starting refinement in $(pwd)..." >&2
npx tsx src/gpt.ts prompts/refine.md "$SUMMARY" > "$REFINED"

# Format
echo "Starting formatting in $(pwd)..." >&2
npx tsx src/gpt.ts prompts/format.md "$REFINED"

# Cleanup temp files
rm "$SUMMARY" "$REFINED"
