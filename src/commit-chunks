#!/bin/bash

# Commit docs in chunks of 500MB

# Check if a commit message was provided
if [ $# -eq 0 ]; then
    echo "Error: Please provide a commit message"
    echo "Usage: $0 \"commit message\""
    exit 1
fi

# Initialize counter for commit parts
part=1

# Keep committing until no more untracked files
while true; do

  # Get list of files to add in this chunk
  files_to_add=$(git status --untracked-files=all --porcelain | \
  awk '/^\?\?/ {print $2}' | \
  xargs -I{} stat -f "%z %N" {} | \
  awk -v chunk_size=$((500*1024*1024)) '
  {
    size=$1;
    file=$2;
    if (current_size + size > chunk_size) {
      exit; # Stop once the first group is complete
    }
    current_size += size;
    print file;
  }')

  # Exit if no more files to add
  if [ -z "$files_to_add" ]; then
    break
  fi

  # Log the current part and files
  echo "Processing part $part with files:"
  echo "$files_to_add" | sed 's/^/  /'

  # Add the files
  echo "$files_to_add" | xargs git add

  # Commit with part number
  git commit -m "$1 (part $part)"

  # Push changes
  git push origin master

  # Increment part counter
  ((part++))
done

echo "Changes committed and pushed successfully"
